
<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Planejador de Jantar de Natal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Montserrat', sans-serif;
      }
      .font-christmas {
        font-family: 'Mountains of Christmas', cursive;
      }
      /* Estilos para a anima√ß√£o do floco de neve */
      @keyframes fall {
          0% {
              transform: translateY(-10vh) rotate(0deg);
          }
          100% {
              transform: translateY(110vh) rotate(360deg);
          }
      }
      .snowflake {
          position: absolute;
          top: -10vh;
          color: white;
          animation-name: fall;
          animation-timing-function: linear;
          animation-iteration-count: infinite;
      }
    </style>
    <!-- Carregar bibliotecas necess√°rias -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Adicionar import map para Gemini API e Supabase -->
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.run/@google/generative-ai",
        "@supabase/supabase-js": "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"
      }
    }
    </script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      // --- IMPORTA√á√ïES ---
      import { GoogleGenerativeAI } from "@google/genai";
      import { createClient } from "@supabase/supabase-js";

      // --- INICIALIZA√á√ÉO DOS CLIENTES ---
      let ai;
      let supabase;
      let configError = null;

      try {
        // A API Key √© obtida a partir das vari√°veis de ambiente do projeto.
        if (!process.env.API_KEY) {
            throw new Error("A API Key do Gemini n√£o foi encontrada. Por favor, configure a vari√°vel de ambiente API_KEY.");
        }
        ai = new GoogleGenerativeAI({apiKey: process.env.API_KEY});
        
        // As credenciais do Supabase s√£o obtidas a partir das vari√°veis de ambiente.
        if (!process.env.SUPABASE_URL || !process.env.SUPABASE_KEY) {
            throw new Error("As credenciais do Supabase n√£o foram encontradas. Por favor, configure as vari√°veis de ambiente SUPABASE_URL e SUPABASE_KEY.");
        }
        supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_KEY);

      } catch (error) {
        console.error("Erro na inicializa√ß√£o:", error.message);
        configError = error.message;
      }


      // --- COMPONENTES DA APLICA√á√ÉO ---

      const ShareIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
          <polyline points="16 6 12 2 8 6"></polyline>
          <line x1="12" y1="2" x2="12" y2="15"></line>
        </svg>
      );

      const DownloadIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
      );

      const SnowflakeIcon = () => {
          const style = {
              left: `${Math.random() * 100}%`,
              animationDuration: `${Math.random() * 10 + 5}s`,
              animationDelay: `${Math.random() * 5}s`,
              opacity: Math.random() * 0.5 + 0.3,
              transform: `scale(${Math.random() * 0.8 + 0.2})`,
          };
          return (
              <div className="snowflake" style={style}>
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round">
                      <line x1="12" y1="2" x2="12" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="5.64" y1="5.64" x2="18.36" y2="18.36"></line><line x1="5.64" y1="18.36" x2="18.36" y2="5.64"></line><line x1="12" y1="2" x2="14" y2="5"></line><line x1="12" y1="2" x2="10" y2="5"></line><line x1="12" y1="22" x2="14" y2="19"></line><line x1="12" y1="22" x2="10" y2="19"></line><line x1="2" y1="12" x2="5" y2="10"></line><line x1="2" y1="12" x2="5" y2="14"></line><line x1="22" y1="12" x2="19" y2="10"></line><line x1="22" y1="12" x2="19" y2="14"></line>
                  </svg>
              </div>
          );
      };

      const Header = () => (
          <header className="text-center w-full max-w-3xl mx-auto">
            <h1 className="font-christmas text-5xl sm:text-6xl md:text-7xl text-white drop-shadow-[0_2px_2px_rgba(0,0,0,0.5)]">
              <span className="text-red-500">Jantar</span> de <span className="text-green-400">Natal</span>
            </h1>
            <p className="mt-2 text-lg text-gray-300">
              Vamos organizar nossa celebra√ß√£o! Por favor, preencha o formul√°rio abaixo.
            </p>
          </header>
      );

      const ChristmasForm = ({ onSubmit, submissions }) => {
        const [name, setName] = React.useState('');
        const [isAttending, setIsAttending] = React.useState(null);
        const [selectedDate, setSelectedDate] = React.useState(null);
        const [error, setError] = React.useState('');
        const [isEditing, setIsEditing] = React.useState(false);
        const [isSubmitting, setIsSubmitting] = React.useState(false);

        React.useEffect(() => {
            const trimmedName = name.trim().toLowerCase();
            if (trimmedName === '') {
              setIsAttending(null);
              setSelectedDate(null);
              setIsEditing(false);
              return;
            }
            const existingSubmission = submissions.find(s => s.name.toLowerCase() === trimmedName);
            if (existingSubmission) {
              setIsAttending(existingSubmission.isAttending);
              setSelectedDate(existingSubmission.selectedDate);
              setIsEditing(true);
            } else {
              if(isEditing) {
                setIsAttending(null);
                setSelectedDate(null);
              }
              setIsEditing(false);
            }
        }, [name, submissions]);

        const handleSubmit = async (e) => {
          e.preventDefault();
          if (!name.trim() || isAttending === null) {
            setError('Por favor, preencha seu nome e confirme sua presen√ßa.');
            return;
          }
          if (isAttending && !selectedDate) {
            setError('Se voc√™ vai, por favor, escolha uma data preferida.');
            return;
          }
          setError('');
          setIsSubmitting(true);
          const submissionData = {
            name: name.trim(),
            isAttending,
            selectedDate: isAttending ? selectedDate : null,
          };
          await onSubmit(submissionData);
          setIsSubmitting(false);
        };

        return (
          <form onSubmit={handleSubmit} className="space-y-6">
            <h2 className="text-2xl font-bold text-center text-green-300 mb-4">{isEditing ? 'Alterar sua Resposta' : 'Confirme sua Presen√ßa'}</h2>
            <div>
              <label htmlFor="name" className="block text-sm font-medium text-gray-300">Seu Nome</label>
              <input
                type="text"
                id="name"
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"
                placeholder="Digite seu nome para responder ou alterar"
                disabled={isSubmitting}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-300">Voc√™ vai participar?</label>
              <div className="mt-2 flex items-center space-x-4">
                <button type="button" disabled={isSubmitting} onClick={() => setIsAttending(true)} className={`px-6 py-2 rounded-lg font-semibold transition-all ${isAttending === true ? 'bg-green-500 text-white ring-2 ring-white' : 'bg-gray-600 hover:bg-gray-500'}`}>Sim</button>
                <button type="button" disabled={isSubmitting} onClick={() => setIsAttending(false)} className={`px-6 py-2 rounded-lg font-semibold transition-all ${isAttending === false ? 'bg-red-500 text-white ring-2 ring-white' : 'bg-gray-600 hover:bg-gray-500'}`}>N√£o</button>
              </div>
            </div>
            {isAttending && (
                <div>
                    <label className="block text-sm font-medium text-gray-300">Qual data prefere?</label>
                    <div className="mt-2 flex items-center space-x-4">
                        <button type="button" disabled={isSubmitting} onClick={() => setSelectedDate('28 de Novembro')} className={`px-6 py-2 rounded-lg font-semibold transition-all ${selectedDate === '28 de Novembro' ? 'bg-yellow-500 text-gray-900 ring-2 ring-white' : 'bg-gray-600 hover:bg-gray-500'}`}>28 Nov</button>
                        <button type="button" disabled={isSubmitting} onClick={() => setSelectedDate('5 de Dezembro')} className={`px-6 py-2 rounded-lg font-semibold transition-all ${selectedDate === '5 de Dezembro' ? 'bg-yellow-500 text-gray-900 ring-2 ring-white' : 'bg-gray-600 hover:bg-gray-500'}`}>5 Dez</button>
                    </div>
                </div>
            )}
            {error && <p className="text-red-400 text-sm text-center">{error}</p>}
            <button
              type="submit"
              disabled={isSubmitting}
              className="w-full bg-yellow-500 hover:bg-yellow-600 disabled:bg-yellow-800 disabled:cursor-wait text-gray-900 font-bold py-3 px-4 rounded-lg transition-colors duration-300 text-lg"
            >
              {isSubmitting ? 'A Enviar...' : (isEditing ? 'Atualizar Resposta' : 'Enviar Resposta')}
            </button>
          </form>
        );
      };
      
      const SubmissionsList = ({ submissions, isLoading, error }) => {
        const sortedSubmissions = React.useMemo(() => {
          if (!submissions) return [];
          return [...submissions].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        }, [submissions]);

        return (
          <div className="bg-white/10 backdrop-blur-md p-6 rounded-2xl shadow-lg border border-white/20">
            <h2 className="text-2xl font-bold text-center text-green-300 mb-4">Lista de Respostas</h2>
            <div className="max-h-96 overflow-y-auto pr-2">
              {isLoading ? (
                 <p className="text-gray-400 text-center">A carregar respostas...</p>
              ) : error ? (
                 <p className="text-red-400 text-center">{error}</p>
              ) : sortedSubmissions.length === 0 ? (
                <p className="text-gray-400 text-center">Ainda ningu√©m respondeu. Seja o primeiro!</p>
              ) : (
                <ul className="space-y-3">
                  {sortedSubmissions.map((sub) => (
                    <li key={sub.id} className={`p-3 rounded-lg flex items-center ${sub.isAttending ? 'bg-green-900/50' : 'bg-red-900/50'}`}>
                      <div className="flex-grow">
                        <p className="font-semibold text-white">{sub.name}</p>
                        {sub.isAttending && sub.selectedDate && (
                           <p className="text-xs text-gray-300 mt-1">Votou em: <strong>{sub.selectedDate}</strong></p>
                        )}
                      </div>
                      {sub.isAttending ? (
                        <span className="text-xs font-bold bg-green-500 text-white py-1 px-2 rounded-full flex-shrink-0">CONFIRMADO</span>
                      ) : (
                        <span className="text-xs font-bold bg-red-500 text-white py-1 px-2 rounded-full flex-shrink-0">N√ÉO VAI</span>
                      )}
                    </li>
                  ))}
                </ul>
              )}
            </div>
          </div>
        );
      };

      const SummaryDisplay = ({ submissions }) => {
        const [summary, setSummary] = React.useState('');
        const [isGenerating, setIsGenerating] = React.useState(false);
        const [error, setError] = React.useState('');
        
        const generateSummary = async () => {
          if (!ai) {
              setError("O cliente Gemini AI n√£o est√° inicializado.");
              return;
          }
          if (submissions.length === 0) {
              setError("N√£o h√° respostas para resumir.");
              setTimeout(() => setError(''), 3000);
              return;
          }

          setIsGenerating(true);
          setError('');
          setSummary('');

          try {
            const attendees = submissions.filter(s => s.isAttending);
            const nonAttendees = submissions.filter(s => !s.isAttending);
            const dateVotes = attendees.reduce((acc, curr) => {
                if (curr.selectedDate) {
                    acc[curr.selectedDate] = (acc[curr.selectedDate] || 0) + 1;
                }
                return acc;
            }, {});

            const prompt = `
              Voc√™ √© um assistente de planeamento de festas de Natal, amig√°vel e festivo.
              Analise a seguinte lista de convidados para um jantar de Natal e crie um resumo.
              
              Dados dos Convidados:
              - Total de convidados que responderam: ${submissions.length}
              - Confirmados (${attendees.length}): ${attendees.map(p => p.name).join(', ') || 'Nenhum'}
              - N√£o v√£o (${nonAttendees.length}): ${nonAttendees.map(p => p.name).join(', ') || 'Nenhum'}
              - Votos por data: ${JSON.stringify(dateVotes)}

              O seu resumo deve:
              1. Come√ßar com uma sauda√ß√£o natal√≠cia.
              2. Indicar o n√∫mero total de pessoas que confirmaram presen√ßa e as que n√£o v√£o.
              3. Anunciar a data mais votada para o jantar. Se houver um empate ou nenhuma vota√ß√£o, mencione isso.
              4. Terminar com uma nota alegre.
              
              Seja conciso e use emojis de Natal.
            `;
            
            const response = await ai.models.generateContent({
                model: "gemini-2.5-flash",
                contents: prompt,
            });

            setSummary(response.text);

          } catch (err) {
            console.error("Erro ao gerar resumo com Gemini:", err);
            setError("Houve um problema ao contactar a IA. Tente novamente.");
          } finally {
            setIsGenerating(false);
          }
        };

        const renderSummary = (text) => {
            return text.split('\n').map((line, index) => {
                if (line.trim() === '') return null;
                if (line.trim().startsWith('* ') || line.trim().startsWith('- ')) {
                    return <p key={index} className="ml-4">{line}</p>;
                }
                return <p key={index} className="mb-2">{line}</p>;
            }).filter(Boolean);
        };

        return (
          <div className="bg-white/10 backdrop-blur-md p-6 rounded-2xl shadow-lg border border-white/20">
            <h2 className="text-2xl font-bold text-center text-green-300 mb-4">Resumo da IA üéÑ</h2>
            <div className="text-gray-300 text-center space-y-2 mb-6">
                <p>Pe√ßa √† nossa IA para analisar as respostas e criar um resumo r√°pido do plano!</p>
            </div>
            <button
              onClick={generateSummary}
              disabled={isGenerating || submissions.length === 0}
              className="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-purple-800 disabled:cursor-wait text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center"
            >
              {isGenerating ? 'A IA est√° a pensar...' : 'Gerar Resumo com IA'}
            </button>
            {error && <p className="text-red-400 text-sm text-center mt-4">{error}</p>}
            {summary && (
                <div className="mt-6 p-4 bg-gray-900/50 rounded-lg border border-gray-600">
                    <div className="text-gray-200">{renderSummary(summary)}</div>
                </div>
            )}
          </div>
        );
      };
      
      const ShareButton = () => {
        const [buttonText, setButtonText] = React.useState('Partilhar Link');

        const handleShare = () => {
          navigator.clipboard.writeText(window.location.href).then(() => {
            setButtonText('Link Copiado!');
            setTimeout(() => setButtonText('Partilhar Link'), 2000);
          }).catch(err => {
            console.error('Failed to copy link: ', err);
            setButtonText('Erro ao copiar');
            setTimeout(() => setButtonText('Partilhar Link'), 2000);
          });
        };

        return (
          <button
            onClick={handleShare}
            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center"
          >
            <ShareIcon />
            <span className="ml-2">{buttonText}</span>
          </button>
        );
      };

      const ExportButton = ({ submissions }) => {
          const attendees = submissions.filter(s => s.isAttending);

          const handleExport = () => {
              if (attendees.length === 0) return;
              const csvHeader = "Nome,Presen√ßa,Data Votada\n";
              const csvRows = attendees.map(attendee => {
                  const name = `"${attendee.name.replace(/"/g, '""')}"`;
                  const presence = "Confirmado";
                  const date = attendee.selectedDate || 'N/A';
                  return `${name},${presence},${date}`;
              }).join('\n');
              const csvContent = csvHeader + csvRows;
              const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.setAttribute('download', 'lista_convidados.csv');
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
          };

          return (
              <button
                  onClick={handleExport}
                  disabled={attendees.length === 0}
                  className="w-full bg-green-600 hover:bg-green-700 disabled:bg-green-800 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center"
              >
                  <DownloadIcon />
                  <span className="ml-2">Exportar Lista</span>
              </button>
          );
      };
      
      const App = () => {
        const { useState, useEffect } = React;

        const [submissions, setSubmissions] = useState([]);
        const [showForm, setShowForm] = useState(true);
        const [isLoading, setIsLoading] = useState(true);
        const [error, setError] = useState(null);

        const fetchSubmissions = async () => {
          setIsLoading(true);
          setError(null);
          const { data, error } = await supabase
            .from('rsvps')
            .select('*');

          if (error) {
            console.error("Erro ao buscar respostas:", error);
            setError("N√£o foi poss√≠vel carregar as respostas. Tente recarregar a p√°gina.");
          } else {
            setSubmissions(data);
          }
          setIsLoading(false);
        };

        useEffect(() => {
          fetchSubmissions();
        }, []);

        const handleSubmission = async (submission) => {
          const trimmedName = submission.name.trim();
          const existingSubmission = submissions.find(s => s.name.toLowerCase() === trimmedName.toLowerCase());
          
          let dbError;

          if (existingSubmission) {
            const { error } = await supabase
              .from('rsvps')
              .update({ isAttending: submission.isAttending, selectedDate: submission.selectedDate })
              .eq('id', existingSubmission.id);
            dbError = error;
          } else {
            const { error } = await supabase
              .from('rsvps')
              .insert([{ name: trimmedName, isAttending: submission.isAttending, selectedDate: submission.selectedDate }]);
            dbError = error;
          }

          if (dbError) {
            console.error("Erro na base de dados:", dbError);
            // Poder√≠amos mostrar um erro no formul√°rio aqui.
          } else {
            await fetchSubmissions();
            setShowForm(false);
          }
        };

        return (
          <div className="min-h-screen bg-gray-900 text-white relative overflow-hidden">
            <div className="absolute inset-0 z-0">
              {[...Array(20)].map((_, i) => <SnowflakeIcon key={i} />)}
            </div>
            <div className="relative z-10 flex flex-col items-center p-4 sm:p-6 md:p-8">
              <Header />
              <div className="w-full max-w-4xl mx-auto mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div className="bg-white/10 backdrop-blur-md p-6 rounded-2xl shadow-lg border border-white/20">
                  {showForm ? (
                     <ChristmasForm onSubmit={handleSubmission} submissions={submissions} />
                  ) : (
                    <div className="text-center flex flex-col items-center justify-center h-full">
                      <h2 className="text-2xl font-bold text-green-300">Obrigado por responder!</h2>
                      <p className="mt-2 text-gray-300">Sua resposta foi registrada com sucesso.</p>
                      <button
                        onClick={() => setShowForm(true)}
                        className="mt-6 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition-colors duration-300"
                      >
                        Adicionar ou Alterar Resposta
                      </button>
                    </div>
                  )}
                </div>
                <div className="space-y-8">
                  <SubmissionsList submissions={submissions} isLoading={isLoading} error={error}/>
                  <SummaryDisplay submissions={submissions} />
                   <div className="bg-white/10 backdrop-blur-md p-6 rounded-2xl shadow-lg border border-white/20">
                    <h2 className="text-2xl font-bold text-center text-green-300 mb-4">A√ß√µes do Painel</h2>
                    <div className="text-gray-300 text-center space-y-2">
                        <p>Partilhe o link da p√°gina ou exporte a lista de confirmados.</p>
                    </div>
                    <div className="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <ShareButton />
                        <ExportButton submissions={submissions} />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }
      
      const rootElement = document.getElementById('root');
      if (configError) {
          const errorMessage = `
              <div class="bg-red-900 text-white p-8 min-h-screen flex items-center justify-center">
                  <div class="text-center max-w-2xl">
                      <h1 class="text-3xl font-bold">Erro de Configura√ß√£o</h1>
                      <p class="mt-4">${configError}</p>
                      <p class="mt-6 text-sm text-gray-300">Por favor, verifique as vari√°veis de ambiente do seu projeto.</p>
                  </div>
              </div>
          `;
          rootElement.innerHTML = errorMessage;
      } else {
        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
      }
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
